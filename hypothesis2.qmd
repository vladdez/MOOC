---
title: "Hypothesis 2"
format:
  html:
    toc: true
    html-math-method: katex
    css: styles.css
    code-fold: true
    code-summary: "Show the code"
editor: visual
#jupyter: julia-1.8
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r, message= FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(dplyr)
library(data.table)
library(lme4)
library(ggplot2)
library(pscl) # for odTest
library(arm)
library(sjPlot)
library(rstatix)
library(car)
library(glue)
library(mediation)
library(utils)
library(arm)


remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

```

```{r, include=FALSE}
wd <- getwd()
system('7z x data/assignments.zip -odata/.')

assignments <- fread("data/assignments.csv") %>%    # works in Ubuntu
  mutate(course_item_type_desc = factor(course_item_type_desc), 
         forum_attendance = ifelse(vis_tw==0, 0, 1), 
         vis_before_attempt_tw_b = ifelse(vis_before_attempt_tw==0, 0, 1), 
         vis_before_attempt_tw_b = factor(vis_before_attempt_tw_b), 
         course_item_type_id = factor(ifelse(course_item_type_id=="106", 0, 1))) %>% # 106 = quiz
  group_by(course_item_id) %>% 
  mutate(difficulty =  sum(first_attempt == 0) / n()) %>% 
  dplyr::rename(CFA = first_attempt, forum_attendance_tw = vis_before_attempt_tw_b) %>% 
  ungroup()  %>% 
  dplyr::select(assignment_time, forum_attendance, difficulty, CFA, forum_attendance_tw, hse_user_id, course_item_name, course_item_type_id, attempts)
#tw <- assignments %>% filter(assignment_time < 116)  # delete observations over 3d quantile
```

## Research questions

  1. Is there a mediation effect between item difficulty and CFA, where forum attendance is a mediator?
  2. Is there a mediation effect between item type and CFA, where forum attendance is a mediator?

## Database desciption

  - **assignments** - database with data on the the level individual assignments
  
## Variables description
 
Important: 

  - **forum_attendance_tw** - Forum attendance during time window (start of assignment-first attempt). Binary.  
  - **forum_visits_tw** - the number of forum visits during time window. Counted.   
  - **CFA** - Correctness of the first attempt. Binary.
  - **difficulty** - the number of students failed  / the number of student participated. From 0 to 1.

Less important:

  - **hse_user_id** - a student token;
  - **course_item_name** and **course_item_type_desc** - item token/name and item type;
  
## Mediation analyses

### Diffculty as DV

```{r}
tw1 <- assignments %>% group_by(hse_user_id) %>% 
  summarise(difficulty = median(difficulty), 
            forum_attendance_tw = median(as.numeric(forum_attendance_tw) - 1), 
            CFA = median(CFA)) 

tw2 <- assignments %>% group_by(course_item_name) %>% 
  summarise(difficulty = median(difficulty), 
            forum_attendance_tw = median(as.numeric(forum_attendance_tw) - 1),  
            CFA = median(CFA)) 
```

#### Grouping by users

```{r}
# Step 1: X ~ Y
fit.totaleffect <- glm(data = data.table(tw1), CFA ~ 1 + forum_attendance_tw , family = "binomial") 
#summary(fit.totaleffect)

# Step 2: M ~ Y
fit.mediator = glm(data = data.table(tw1), forum_attendance_tw ~ 1 + difficulty , family = "binomial") 
#summary(fit.mediator)
# there is an effect

# Step 3: X + M ~ Y
fit.dv = glm(data = data.table(tw1), CFA ~ 1 + forum_attendance_tw + difficulty, family = "binomial")
#summary(fit.dv)
# there is an effect, but mediation is incomplete

# Step 4: Run the mediation analysis
results_m1 = mediate(fit.mediator, fit.dv, treat='difficulty', mediator='forum_attendance_tw')

# Step 5: View the mediation results
summary(results_m1)
``` 

```{r}
cat(sprintf("Step 1: X ~ Y\nTotal effect is %.4f.\n\n", summary(results_m1)$tau.coef))

cat(sprintf("Step 2: M ~ Y\nAverage causal mediation effect (ACME) is %.5f.\nThis is the indirect effect of the IV (item difficulty) \non the DV (CFA) that goes through the mediator (forum attendance).\n\n", summary(results_m1)$d0))

cat(sprintf("Step 3: X + M ~ Y\nAverage direct effect of the IV on the DV is %.4f.\n\n",  summary(results_m1)$z0))

```

#### Grouping by courses

```{r}
# Step 1: X ~ Y
fit.totaleffect <- glm(data = data.table(tw2), CFA ~ 1 + forum_attendance_tw , family = "binomial") 
#summary(fit.totaleffect)
# there is an effect

# Step 2: M ~ Y
fit.mediator = glm(data = data.table(tw2), forum_attendance_tw ~ 1 + difficulty , family = "binomial") 
#summary(fit.mediator)
# there is an effect

# Step 3: X + M ~ Y
fit.dv = glm(data = data.table(tw2), CFA ~ 1 + forum_attendance_tw + difficulty, family = "binomial")
#summary(fit.dv)

# there is an effect, but mediation is incomplete

# Step 4: Run the mediation analysis
results_m2 = mediate(fit.mediator, fit.dv, treat='difficulty', mediator='forum_attendance_tw')

# Step 5: View the mediation results
summary(results_m2)
```


```{r}
cat(sprintf("Step 1: X ~ Y\nTotal effect is %.4f.\n\n", summary(results_m2)$tau.coef))

cat(sprintf("Step 2: M ~ Y\nAverage causal mediation effect (ACME) is %.5f.\nThis is the indirect effect of the IV (item difficulty) \non the DV (CFA) that goes through the mediator (forum attendance).\n\n", summary(results_m2)$d0))

cat(sprintf("Step 3: X + M ~ Y\nAverage direct effect of the IV on the DV is %.4f.\n\n",  summary(results_m2)$z0))
```

### Type as DV

```{r}
tw3 <- assignments %>% group_by(hse_user_id) %>% summarise(course_item_type_id = median(as.numeric(course_item_type_id) - 1), forum_attendance_tw = median(as.numeric(forum_attendance_tw) - 1), CFA = median(CFA)) 

tw4 <- assignments %>% group_by(course_item_name) %>% summarise(course_item_type_id = median(as.numeric(course_item_type_id) - 1), forum_attendance_tw = median(as.numeric(forum_attendance_tw) - 1), CFA = median(CFA)) 
```

#### Groupung by users

```{r}
fit.totaleffect <- glm(data = data.table(tw3), CFA ~ 1 + course_item_type_id , family = "binomial") 
#summary(fit.totaleffect)

fit.mediator = glm(data = data.table(tw3), forum_attendance_tw ~ 1 + course_item_type_id , family = "binomial") 
#summary(fit.mediator)
# there is an effect

fit.dv = glm(data = data.table(tw3), CFA ~ 1 + forum_attendance_tw + course_item_type_id, family = "binomial")
#summary(fit.dv)

results_m1 = mediate(fit.mediator, fit.dv, treat='course_item_type_id', mediator='forum_attendance_tw')
summary(results_m1)
```


```{r}
cat(sprintf("Step 1: X ~ Y\nTotal effect is %.4f.\n\n", summary(results_m1)$tau.coef))

cat(sprintf("Step 2: M ~ Y\nAverage causal mediation effect (ACME) is %.5f.\nThis is the indirect effect of the IV (item type) \non the DV (CFA) that goes through the mediator (forum attendance).\n\n", summary(results_m1)$d0))

cat(sprintf("Step 3: X + M ~ Y\nAverage direct effect of the IV on the DV is %.4f.\n\n",  summary(results_m1)$z0))
```

#### Grouping by courses

```{r}
# Step 1: X ~ Y
fit.totaleffect <- glm(data = data.table(tw4), CFA ~ 1 + course_item_type_id , family = "binomial") 
#summary(fit.totaleffect)
# there is an effect

# Step 2: M ~ Y
fit.mediator = glm(data = data.table(tw4), forum_attendance_tw ~ 1 + course_item_type_id , family = "binomial") 
#summary(fit.mediator)
# there is an effect

# Step 3: X + M ~ Y
fit.dv = glm(data = data.table(tw4), CFA ~ 1 + forum_attendance_tw + course_item_type_id, family = "binomial")
#summary(fit.dv)

# there is an effect, but mediation is incomplete

# Step 4: Run the mediation analysis
results_m2 = mediate(fit.mediator, fit.dv, treat='course_item_type_id', mediator='forum_attendance_tw')
summary(results_m2)

```


```{r}
cat(sprintf("Step 1: X ~ Y\nTotal effect is %.4f.\n\n", summary(results_m2)$tau.coef))

cat(sprintf("Step 2: M ~ Y\nAverage causal mediation effect (ACME) is %.5f.\nThis is the indirect effect of the IV (item type) \non the DV (CFA) that goes through the mediator (forum attendance).\n\n", summary(results_m2)$d0))

cat(sprintf("Step 3: X + M ~ Y\nAverage direct effect of the IV on the DV is %.4f.\n\n",  summary(results_m2)$z0))
```

## Results

https://towardsdatascience.com/doing-and-reporting-your-first-mediation-analysis-in-r-2fe423b92171
